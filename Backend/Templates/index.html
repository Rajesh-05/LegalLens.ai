<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditDesk.ai - AI-Powered Tax Filing Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Navigation */
        nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Screen Management */
        .screen {
            display: none;
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }

        .screen.active {
            display: block;
        }

        /* Home Screen */
        .hero {
            text-align: center;
            padding: 4rem 0;
            color: white;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ffffff, #f0f8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 4rem;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            color: white;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Chat Screen */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            max-width: 800px;
            margin: 2rem auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem 1.5rem;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .message.bot {
            align-self: flex-start;
            background: #f1f3f4;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .chat-input-container {
            padding: 1.5rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        /* Upload Screen */
        .upload-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            max-width: 600px;
            margin: 2rem auto;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 3rem;
            margin: 2rem 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.dragover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        .form-group {
            margin: 1.5rem 0;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .upload-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: transform 0.2s ease;
        }

        .upload-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .upload-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Download Screen */
        .download-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            max-width: 500px;
            margin: 4rem auto;
            padding: 4rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .download-icon {
            font-size: 5rem;
            color: #4CAF50;
            margin-bottom: 2rem;
        }

        .download-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 1.5rem 3rem;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .download-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(76, 175, 80, 0.4);
        }

        /* Loading and Status */
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin: 1rem 0;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-message {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 10px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .nav-menu {
                gap: 1rem;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
            
            .upload-container,
            .chat-container {
                margin: 1rem;
                padding: 2rem 1.5rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <div class="nav-container">
                <a href="#" class="logo">AuditDesk.ai</a>
                <ul class="nav-menu">
                    <li><span class="nav-link active" data-screen="home">Home</span></li>
                    <li><span class="nav-link" data-screen="chat">Chat</span></li>
                    <li><span class="nav-link" data-screen="upload">Upload AIS</span></li>
                    <li><span class="nav-link" data-screen="download">Download ITR</span></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Home Screen -->
    <div id="home" class="screen active">
        <div class="container">
            <div class="hero">
                <h1>AuditDesk.ai</h1>
                <p>Transform your tax filing experience with AI-powered automation. Upload your AIS documents, chat about your income sources, and get your ITR filed effortlessly.</p>
                <button class="cta-button" onclick="switchScreen('chat')">Get Started</button>
            </div>

            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">💬</div>
                    <h3>Smart Chat Assistant</h3>
                    <p>Tell us about your income sources through natural conversation. Our AI understands and processes your financial information intelligently.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📄</div>
                    <h3>AIS Document Upload</h3>
                    <p>Securely upload your Annual Information Statement (AIS) with password protection. We handle all document processing automatically.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3>Instant ITR Generation</h3>
                    <p>Get your completed Income Tax Return form ready for download in minutes. Fast, accurate, and compliant with latest regulations.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat" class="screen">
        <div class="container">
            <div class="chat-container">
                <div class="chat-header">
                    <h2>💬 Tell us about your Income Sources</h2>
                    <p>Chat with our AI to provide details about your income</p>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <strong></strong> 
                        Hello! I'm here to help you identify and gather information about all your income sources for accurate tax filing. I'll ask you some questions to ensure we cover everything comprehensively. Can we start ?
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message about income sources..." onkeypress="handleEnterKey(event)">
                    <button class="send-button" onclick="sendMessage()">
                        <span>→</span>
                    </button>
                </div>
                <div class="loading" id="chatLoading">
                    <div class="spinner"></div>
                    Processing your message...
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Screen -->
    <div id="upload" class="screen">
        <div class="container">
            <div class="upload-container">
                <h2>📄 Upload Your AIS Document</h2>
                <p>Upload your Annual Information Statement (AIS) PDF file along with its password</p>

                <div class="upload-area" onclick="document.getElementById('pdfFile').click()" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                    <div class="upload-icon">📁</div>
                    <h3>Click to upload or drag and drop</h3>
                    <p>PDF files only</p>
                    <input type="file" id="pdfFile" class="file-input" accept=".pdf" onchange="handleFileSelect(event)">
                </div>

                <div class="form-group">
                    <label class="form-label" for="pdfPassword">PDF Password:</label>
                    <input type="password" id="pdfPassword" class="form-input" placeholder="Enter your AIS PDF password">
                </div>

                <button class="upload-button" id="uploadButton" onclick="uploadDocument()" disabled>
                    Upload Document
                </button>

                <div class="loading" id="uploadLoading">
                    <div class="spinner"></div>
                    Uploading and processing your document...
                </div>

                <div class="status-message" id="uploadStatus"></div>
            </div>
        </div>
    </div>

    <!-- Download Screen -->
    <div id="download" class="screen">
        <div class="container">
            <div class="download-container">
                <div class="download-icon">✅</div>
                <h2>Your ITR is Ready!</h2>
                <p>Your Income Tax Return has been successfully generated and is ready for download.</p>
                
                <button class="download-button" onclick="downloadITR()">
                    📥 Download ITR
                </button>

                <div class="loading" id="downloadLoading">
                    <div class="spinner"></div>
                    Preparing your download...
                </div>
            </div>
        </div>
    </div>

    <script>
        let isNewChat = 1;
        let selectedFile = null;

        // Screen switching
        function switchScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            document.getElementById(screenName).classList.add('active');
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-screen="${screenName}"]`).classList.add('active');
        }

        // Navigation event listeners
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const screen = e.target.getAttribute('data-screen');
                if (screen) switchScreen(screen);
            });
        });

        // Chat functionality
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            if (isUser) {
                messageDiv.innerHTML = `${content}`;
            } else {
                messageDiv.innerHTML = `${content}`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, true);
            input.value = '';
            
            // Show loading
            const loading = document.getElementById('chatLoading');
            loading.style.display = 'block';
            
            try {
                const formData2 = new FormData();
                formData2.append('user_query', message);
                formData2.append('is_new_chat', isNewChat);
                // formData2.append('image','')
                const response = await fetch('http://127.0.0.1:3500/get_details', {
                    method: 'POST',
                    // headers: {
                    //     'Content-Type': 'application/json',
                    // },
                    // body: JSON.stringify({
                    //     user_query: message,
                    //     is_new_chat: isNewChat
                    // })
                    body:formData2
                });
                
                const data = await response.json();
                
                const res = marked.parse(data.response);

                // Add bot response
                addMessage(res || "I understand. Please provide more details about your income sources.");
                
                // After first message, it's no longer a new chat
                isNewChat = 0;
                
            } catch (error) {
                console.error('Error:', error);
                addMessage("I'm sorry, there was an error processing your message. Please try again.");
            } finally {
                loading.style.display = 'none';
            }
        }

        // File upload functionality
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                selectedFile = file;
                updateUploadButton();
                updateUploadArea(file.name);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                selectedFile = files[0];
                updateUploadButton();
                updateUploadArea(files[0].name);
                document.getElementById('pdfFile').files = files;
            }
        }

        function updateUploadArea(filename) {
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <div class="upload-icon">📄</div>
                <h3>File Selected</h3>
                <p>${filename}</p>
                <small>Click to change file</small>
            `;
        }

        function updateUploadButton() {
            const button = document.getElementById('uploadButton');
            const password = document.getElementById('pdfPassword').value;
            button.disabled = !(selectedFile && password);
        }

        // Update button state when password changes
        document.getElementById('pdfPassword').addEventListener('input', updateUploadButton);

        async function uploadDocument() {
            if (!selectedFile) return;
            
            const password = document.getElementById('pdfPassword').value;
            if (!password) return;
            
            const loading = document.getElementById('uploadLoading');
            const status = document.getElementById('uploadStatus');
            const button = document.getElementById('uploadButton');
            
            loading.style.display = 'block';
            status.style.display = 'none';
            button.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('pdf', selectedFile);
                formData.append('password', password);
                
                const response = await fetch('http://127.0.0.1:3500/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    status.className = 'status-message status-success';
                    status.textContent = 'Document uploaded and processed successfully!';
                    status.style.display = 'block';
                    
                    // Auto-navigate to download screen after success
                    setTimeout(() => {
                        switchScreen('download');
                    }, 2000);
                } else {
                    throw new Error('Upload failed');
                }
                
            } catch (error) {
                console.error('Error:', error);
                status.className = 'status-message status-error';
                status.textContent = 'Upload failed. Please check your file and password and try again.';
                status.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                button.disabled = false;
            }
        }

        // Download functionality
        function downloadITR() {
            const loading = document.getElementById('downloadLoading');
            loading.style.display = 'block';
            
            // Simulate download preparation
            setTimeout(() => {
                // Create a download link for demonstration
                const link = document.createElement('a');
                link.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent('Your ITR document would be downloaded here.');
                link.download = 'ITR_Form.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                loading.style.display = 'none';
            }, 2000);
        }
    </script>
</body>
</html>